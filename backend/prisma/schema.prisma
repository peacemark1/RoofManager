generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// TENANT MANAGEMENT
// ============================================================================

model Company {
  id                String   @id @default(uuid())
  name              String
  subdomain         String   @unique
  email             String?
  phone             String?
  address           String?
  city              String?
  state             String?
  zipCode           String?
  country           String   @default("US")
  timezone          String   @default("America/New_York")
  currency          String   @default("USD")
  logo              String?
  website           String?
  primaryColor      String   @default("#1e40af")
  secondaryColor    String   @default("#3b82f6")
  font              String   @default("Inter")
  enabledModules    String   @default("{\"ai\": true, \"payments\": true, \"chatbot\": true}")
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  users             User[]
  leads             Lead[]
  jobs              Job[]
  estimates         Estimate[]
  quotes            Quote[]
  invoices          Invoice[]
  materials         Material[]
  notifications     Notification[]
  chatMessages      ChatMessage[]
  subscription      Subscription?
  metrics           CompanyMetrics[]
  customers         Customer[]
  
  @@index([subdomain])
}

model User {
  id                String   @id @default(uuid())
  email             String   @unique
  password          String
  firstName         String
  lastName          String
  phone             String?
  role              String
  isActive          Boolean  @default(true)
  
  // Notification preferences (stored as JSON)
  emailNotifications String     @default("{}")
  smsNotifications   String     @default("{}")
  
  // Quiet hours (no SMS between these times)
  quietHoursStart    String?  @default("21:00")
  quietHoursEnd      String?  @default("07:00")
  
  // Invoice threshold (only notify for amounts above this)
  invoiceThreshold   Float    @default(0)
  
  companyId         String
  company           Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  assignedJobs      JobAssignment[]
  timeLogs          TimeLog[]
  incidentReports   IncidentReport[]
  createdEstimates  Estimate[]
  createdQuotes     Quote[]
  
  @@index([companyId])
  @@index([email])
}



model Subscription {
  id                String    @id @default(uuid())
  tier              String
  status            String
  stripeCustomerId  String?
  stripeSubId       String?
  currentPeriodEnd  DateTime?
  startDate         DateTime  @default(now())
  billingCycle      String    @default("MONTHLY")
  maxUsers          Int       @default(3)
  maxJobs           Int       @default(10)
  maxStorage        BigInt    @default(1073741824) // 1GB
  features          String    @default("{\"ai\": false, \"payments\": true, \"chatbot\": false}")
  
  companyId         String    @unique
  company           Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([companyId])
}





// ============================================================================
// LEAD & JOB PIPELINE
// ============================================================================

model Lead {
  id                String   @id @default(uuid())
  firstName         String
  lastName          String
  email             String
  phone             String
  address           String?
  source            String
  status            String
  notes             String?
  
  companyId         String
  company           Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  jobId             String?  @unique
  job               Job?     @relation("LeadToJob")
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([companyId])
  @@index([status])
}





model Job {
  id                String   @id @default(uuid())
  jobNumber         String   @unique
  title             String
  description       String?
  address           String
  latitude          Float?
  longitude         Float?
  
  propertyType      String
  roofSize          Float?    // square feet
  roofPitch         String?
  status            String
  
  scheduledStart    DateTime?
  scheduledEnd      DateTime?
  actualStart       DateTime?
  actualEnd         DateTime?
  
  estimatedCost     Float?
  actualCost        Float?
  
  // Customer info (denormalized for convenience)
  customerName      String?
  customerEmail     String?
  customerPhone     String?
  
  customerId        String?
  customer          Customer? @relation(fields: [customerId], references: [id])
  
  companyId         String
  company           Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  leadId            String?  @unique
  lead              Lead?    @relation("LeadToJob", fields: [leadId], references: [id])
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  assignments       JobAssignment[]
  photos            JobPhoto[]
  materials         JobMaterial[]
  estimates         Estimate[]
  quotes            Quote[]
  invoices          Invoice[]
  timeLogs          TimeLog[]
  incidents         IncidentReport[]
  
  @@index([companyId])
  @@index([status])
  @@index([jobNumber])
  @@index([customerId])
}





model JobAssignment {
  id                String   @id @default(uuid())
  
  jobId             String
  job               Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  role              String   // "foreman", "crew_member", etc.
  assignedAt        DateTime @default(now())
  
  @@unique([jobId, userId])
  @@index([jobId])
  @@index([userId])
}

model JobPhoto {
  id                String   @id @default(uuid())
  url               String
  caption           String?
  latitude          Float?
  longitude         Float?
  takenAt           DateTime @default(now())
  
  jobId             String
  job               Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  
  uploadedBy        String   // userId
  
  createdAt         DateTime @default(now())
  
  @@index([jobId])
}

// ============================================================================
// ESTIMATION & QUOTING
// ============================================================================

model Estimate {
  id                String   @id @default(uuid())
  laborHours        Float
  totalCost         Float
  timeline          String
  aiGenerated       Boolean  @default(false)
  aiConfidence      Float?
  notes             String?
  
  jobId             String
  job               Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  
  companyId         String
  company           Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdBy         String
  creator           User     @relation(fields: [createdBy], references: [id])
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  materials         EstimateMaterial[]
  
  @@index([jobId])
  @@index([companyId])
}

model EstimateMaterial {
  id                String   @id @default(uuid())
  name              String
  quantity          Float
  unit              String
  estimatedCost     Float
  
  estimateId        String
  estimate          Estimate @relation(fields: [estimateId], references: [id], onDelete: Cascade)
  
  @@index([estimateId])
}

model Quote {
  id                String   @id @default(uuid())
  quoteNumber       String   @unique
  validUntil        DateTime
  status            String
  pdfUrl            String?
  publicLink        String   @unique
  
  lineItems         String     // Array of {description, quantity, unitPrice, total}
  subtotal          Float
  tax               Float    @default(0)
  discount          Float    @default(0)
  total             Float
  
  notes             String?
  termsAndConditions String?
  
  // Customer info (denormalized for convenience)
  customerName      String?
  customerEmail     String?
  customerPhone     String?
  
  customerId        String?
  customer          Customer? @relation(fields: [customerId], references: [id])
  
  jobId             String
  job               Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  
  companyId         String
  company           Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdBy         String
  creator           User     @relation(fields: [createdBy], references: [id])
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  approval          QuoteApproval?
  invoice           Invoice?
  
  @@index([jobId])
  @@index([companyId])
  @@index([publicLink])
  @@index([customerId])
}



model QuoteApproval {
  id                String   @id @default(uuid())
  signatureUrl      String?
  signedBy          String   // Customer name
  signedAt          DateTime
  ipAddress         String?
  
  quoteId           String   @unique
  quote             Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  
  @@index([quoteId])
}

// ============================================================================
// INVENTORY & MATERIALS
// ============================================================================

model Material {
  id                String   @id @default(uuid())
  name              String
  description       String?
  sku               String?
  category          String
  unit              String   // "sq ft", "bundle", "piece"
  costPerUnit       Float
  stockLevel        Int      @default(0)
  reorderPoint      Int      @default(0)
  supplier          String?
  
  companyId         String
  company           Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  jobMaterials      JobMaterial[]
  purchaseOrders    PurchaseOrderItem[]
  
  @@index([companyId])
  @@index([category])
}

model JobMaterial {
  id                String   @id @default(uuid())
  quantityPlanned   Float
  quantityUsed      Float    @default(0)
  
  jobId             String
  job               Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  
  materialId        String
  material          Material @relation(fields: [materialId], references: [id])
  
  @@unique([jobId, materialId])
  @@index([jobId])
  @@index([materialId])
}

model PurchaseOrder {
  id                String   @id @default(uuid())
  poNumber          String   @unique
  supplier          String
  status            String
  orderDate         DateTime @default(now())
  expectedDate      DateTime?
  receivedDate      DateTime?
  totalCost         Float
  
  items             PurchaseOrderItem[]
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([poNumber])
}



model PurchaseOrderItem {
  id                String   @id @default(uuid())
  quantity          Float
  unitCost          Float
  totalCost         Float
  
  purchaseOrderId   String
  purchaseOrder     PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  
  materialId        String
  material          Material @relation(fields: [materialId], references: [id])
  
  @@index([purchaseOrderId])
  @@index([materialId])
}

// ============================================================================
// FINANCIALS
// ============================================================================

model Invoice {
  id                String   @id @default(uuid())
  invoiceNumber     String   @unique
  dueDate           DateTime
  status            String
  pdfUrl            String?
  
  lineItems         String
  subtotal          Float
  tax               Float
  total             Float
  amountPaid        Float    @default(0)
  
  currency          String   @default("USD")
  countryCode       String   @default("US")
  
  customerId        String?
  customer          Customer? @relation(fields: [customerId], references: [id])
  
  jobId             String
  job               Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  
  companyId         String
  company           Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  quoteId           String?  @unique
  quote             Quote?   @relation(fields: [quoteId], references: [id])
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  payments          Payment[]
  
  @@index([jobId])
  @@index([companyId])
  @@index([invoiceNumber])
  @@index([customerId])
}



model Payment {
  id                String   @id @default(uuid())
  amount            Float
  method            String
  transactionId     String?
  stripePaymentId   String?
  status            String
  paidAt            DateTime?
  
  invoiceId         String
  invoice           Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([invoiceId])
  @@index([stripePaymentId])
}





// ============================================================================
// COMMUNICATION
// ============================================================================

model Notification {
  id                String   @id @default(uuid())
  type              String
  channel           String
  recipient         String   // email or phone
  subject           String?
  body              String
  status            String
  sentAt            DateTime?
  errorMessage      String?
  
  companyId         String
  company           Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt         DateTime @default(now())
  
  @@index([companyId])
  @@index([status])
}







model ChatMessage {
  id                String   @id @default(uuid())
  senderId          String   // userId or "system" or "bot"
  senderName        String
  message           String
  isBot             Boolean  @default(false)
  
  companyId         String
  company           Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt         DateTime @default(now())
  
  @@index([companyId])
  @@index([createdAt])
}

// ============================================================================
// ANALYTICS & OPERATIONS
// ============================================================================

model TimeLog {
  id                String   @id @default(uuid())
  startTime         DateTime
  endTime           DateTime?
  totalHours        Float?
  notes             String?
  
  jobId             String
  job               Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  
  userId            String
  user              User     @relation(fields: [userId], references: [id])
  
  createdAt         DateTime @default(now())
  
  @@index([jobId])
  @@index([userId])
}

model IncidentReport {
  id                String   @id @default(uuid())
  title             String
  description       String
  severity          String
  resolvedAt        DateTime?
  resolution        String?
  
  jobId             String
  job               Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  
  reportedBy        String
  reporter          User     @relation(fields: [reportedBy], references: [id])
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([jobId])
  @@index([severity])
}



model CompanyMetrics {
  id                String   @id @default(uuid())
  date              DateTime
  
  totalRevenue      Float    @default(0)
  totalCosts        Float    @default(0)
  netProfit         Float    @default(0)
  
  leadsCreated      Int      @default(0)
  leadsConverted    Int      @default(0)
  conversionRate    Float    @default(0)
  
  jobsCompleted     Int      @default(0)
  avgJobDuration    Float?
  crewEfficiency    Float?
  
  companyId         String
  company           Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt         DateTime @default(now())
  
  @@unique([companyId, date])
  @@index([companyId])
  @@index([date])
}

// ============================================================================
// CUSTOMER PORTAL
// ============================================================================

model Customer {
  id                String   @id @default(uuid())
  name              String
  email             String   @unique
  phone             String?
  address           String?
  
  // Portal access tokens
  accessToken       String?   @unique
  tokenExpiresAt    DateTime?
  
  companyId         String
  company           Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  quotes            Quote[]
  invoices          Invoice[]
  jobs              Job[]
  
  @@index([companyId])
  @@index([email])
  @@index([accessToken])
}
